# 데이터베이스 Lock 

## Lock 이란? 
트랜잭션에 UPDATE중인 데이터에 대한 Lock을 제공하고 트랜잭션이 락을 반납할때 까지 데이터에 대한 다른 트랜잭션의 UPDATE을 차단한다. 

## Lock의 존재 이유
A트랜잭션이 데이터를 수정하고 Commit하기전의 상황에 B트랜잭션이 해당 데이터를 수정한다면 트랜잭션의 격리성이 보장되지 않을뿐더러 데이터 정합성에 문제가 발생한다. 

이로 인해 트랜잭션이 데이터에 대한 Lock을 가지고 있다가 종료시점에 반납하고 타 트랜잭션은 락이 반납될때 까지 대기하게 된다.

## Lock의 종류
* Shared Lock(공유 Lock, Read Lock)
    * 데이터의 동시 읽기는 허용한다. 
    * 데이터의 일관성과 무결성을 해치지 않으면서 성능을 높이기 위해 사용 
    * 읽기 작업이 많은 환경에서 적합하다.
    * 다른 트랜잭션이 데이터 읽기는 가능하지만 변경하는 것은 불가능하다. 
* Exclusive Lock(배타적 Lock, Write Lock)
    * 다른 트랜잭션의 데이터 조회, 수정을 막는다. 
    * 데이터의 일관성과 무결성을 보장하기 위한 Lock
    * 데이터의 무결성을 촘촘하게 보장할 수 있으나 병행성이 저하되기 때문에 Shared Lock 과의 적절한 조합이 필요하다. 

## Blokcing 
Lock들의 경합이 발생해서 특정 트랜잭션이 작업하지 못하고 대기중인 상태로 선행된 트랜잭션이 Lock을 반납할때 까지 대기해야 하기 때문에 성능의 저하가 발생하고 타임아웃 시간이 지나면 예외가 발생한다. 

* 블로킹 해결 방법
    * 트랜잭션을 가능한선에서 짧게 잡아 경합을 줄인다. 
    * 동일한 데이터를 동시에 변경하는 작업을 피하도록 설계한다.
    * 트랜잭션이 자주 발생하는 시간대에 대용량 데이터의 작업을 피한다. 

## 락 타임아웃
설정된 락 타임아웃 시간동안 세션이 락을 얻지 못하면 락 타임아웃 오류가 발생한다. 

## select 데이터의 락 
일반적인 select 조회는 락을 사용하지 않는다. 
DB마다 다르지만 보통 조회는 락을 획득하지 않고 바로 조회한다. 하지만 명시적으로 데이터 조회때도 락을 걸 수 있는데 `select for update`구문을 사용하면 된다. 

만약 데이터를 조회해서 애플리케이션에서 특정 로직을 수행할때 까지 데이터가 변경되지 않아야된다는 상황이 있다면 이럴 때 조회 시점에 락을 획득하여 처리 하면된다. 