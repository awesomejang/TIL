# [Spring] 트랜잭션 전파

트랜잭션은 서로 영향을 줄수 없다. 트랜잭션이 커밋, 롤백 되는것이 다른 트랜잭션에 전혀 영향이 없다. 하지만 트랜잭션이 진행되는중에 내부에서 추가로 트랜잭션이 수행되면 어떨까?

이런 경우 어떻게 동작할지에 대해 결정하는 것이 트랜잭션 전파(propagation)라 한다. 
스프링은 다양한 트랜잭션 전파 옵션을 제공한다.


## REQUIRED(기본 옵션)
A트랜잭션 안에서 B트랜잭션이 수행되면 A, B트랜잭션을 묶어서 하나의 트랜잭션으로 만들어준다. 내부 트랜잭션(B)이 외부 트랜잭션(A)에 참여하는것이다. 참여는 내부 트랜잭션이 외부 트랜잭션을 그대로 이어 받아서 따른다는 것이다. 이것이 전파 옵션의 기본 동작이다. 

스프링은 논리 트랜잭션과 물리 트랜잭션이라는 개념을 나눈다. 논리 트랜잭션은 하나의 물리 트랜잭션으로 묶인다. 

물리 트랜잭션이 기존에 이해하고 있는 트랜잭션이다. 커넥션을 통해 트랜잭션을 시작하고 실제 커넥션을 커밋, 롤백하는 단위이다. 논리 트랜잭션은 트랜잭션 매니저를 통해 트랜잭션을 사용하는 단위

__REQUIRED 원칙__
* 모든 논리 트랜잭션이 커밋되어야 물리 트랜잭션도 커밋된다. 
* 한개의 논리 트랜잭션 이라도 롤백되면 물리 트랜잭션은 롤백된다. 

__내부에서 커밋, 롤백이 발생하면__

외부 트랜잭션이 시작, 커밋할때만 DB 커넥션을 통한 물리 트랜잭션을 시작하고, 커넥션을 트랜잭션 동기화 매니저에 담아둔다. 내부 트랜잭션이 실제 물리 트랜잭션을 커밋하면 트랜잭션이 종료되기 때문에 트랜잭션 동기화 매니저를 통해 해당 트랜잭션이 내부 트랜잭션 이라면 커밋, 롤백의 동작이 작동하지 않는다. 

즉 외부에서 시작된 물리적인 트랜잭션의 범위가 내부 트랜잭션까지 넓어진다. 하나의 물리 트랜잭션으로 묶이는 것이다. 하지만 내부 트랜잭션이 사용하는 커넥션은 신규(물리)가 아니므로 물리 커넥션을 제어할 수 가 없게 되는것이다.

__스프링의 외부, 내부 트랜잭션 관리__

"외부, 내부 트랜잭션을 하나의 물리 트랜잭션으로 묶어서 동작하는 방식은?"

* 외부 트랜잭션
    * 트랜잭션 매니저가 커넥션을 생성하고 물리 트랜잭션 시작한다.     
    * 트랜잭션 매니저는 트랜잭션 동기화 매니저에 커넥션 보관
    * 트랜잭션 매니저는 트랜잭션의 신규생성여부를 담아서 반환한다. 
    * 외부 로직이 실행되고 트랜잭션이 필요한 경우 트랜잭션 동기화 매니저에서 커넥션을 가져와 사용한다. 
* 내부 트랜잭션
    * 기존 트랜잭션이 존재하는지 확인
    * 기존 트랜잭션이 있으므로 기존 트랜잭션에 참여(새로 생성하지 않음)
    * 외부 로직 실행시 신규 트랜잭션 여부를 확인하면 기존 트랜잭션을 사용하기에 신규가 아니다. `TransactionStatus`

